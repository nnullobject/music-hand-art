<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Gemini Nebula - V9 Master</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui { position: absolute; top: 30px; left: 30px; color: #fff; pointer-events: none; z-index: 10; }
        h1 { margin: 0; font-weight: 100; letter-spacing: 5px; font-size: 16px; color: #00f2ff; }
        .status-box { background: rgba(0,0,0,0.6); padding: 12px; border-left: 3px solid #00f2ff; margin-top: 10px; backdrop-filter: blur(10px); }
        p { margin: 3px 0; font-size: 11px; color: #00f2ff; }
        #chorus-active { font-weight: bold; color: #ff00ff; display: none; text-shadow: 0 0 10px #ff00ff; animation: blink 0.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        canvas { display: block; }
    </style>
</head>
<body>
    <div id="ui">
        <h1>NEBULA / MASTER V9</h1>
        <div class="status-box">
            <p>æ¨¡å¼ï¼š<span id="current-mode">è«æ¯”çƒæ–¯ç’°</span></p>
            <p>èƒ½é‡ï¼š<span id="energy-level">0%</span> (å‰¯æ­Œé–€æª»: 20%)</p>
            <p id="chorus-active">ğŸ”¥ CHORUS MODE ACTIVE ğŸ”¥</p>
            <p>æ‰‹å‹¢ï¼šæ¯” 1 å‘å·¦æ®åˆ‡æ›å½¢æ…‹</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script id="vertexShader" type="x-shader/x-vertex">
        uniform float uTime;
        uniform float uAudioHigh;
        uniform float uChorusMode; 
        uniform vec3 uHandPos;
        uniform float uMorph; 
        attribute float aSize;
        attribute float aIndex;
        varying vec3 vColor;

        float hash(float n) { return fract(sin(n) * 43758.5453123); }

        void main() {
            float i = aIndex;
            float total = 50000.0;
            float t = uTime * 0.15;
            
            // --- è«æ¯”çƒæ–¯ç’°ï¼šæ•¸å­¸é–‰åˆä¿®æ­£ç‰ˆ ---
            // è®“ u ç¨å¾®è¶…é 2pi (6.283185 + 0.1) ç¢ºä¿éŠœæ¥è™•é‡ç–Š
            float u = (i / total) * 6.2831853; 
            
            // è«æ¯”çƒæ–¯ç’°çš„å¯¬åº¦èˆ‡æ‰­è½‰è¨ˆç®—
            float w = 2.5; 
            float a = u * 0.5; // æ‰­è½‰è§’
            float v = sin(t + u * 2.0) * w + (hash(i) - 0.5) * 1.5;

            vec3 posA;
            posA.x = (8.0 + v * cos(a)) * cos(u);
            posA.y = (8.0 + v * cos(a)) * sin(u);
            posA.z = v * sin(a);

            // --- èºæ—‹çƒé«” ---
            float phi = acos(1.0 - 2.0 * (i / total));
            float theta = sqrt(total * 3.14159) * phi + t;
            vec3 posB = vec3(8.5 * cos(theta) * sin(phi), 8.5 * sin(theta) * sin(phi), 8.5 * cos(phi));

            // å½¢æ…‹èåˆ (Morphing)
            vec3 basePos = mix(posA, posB, uMorph);
            
            // æ‰‹å‹¢å¼•åŠ›
            float dist = distance(basePos, uHandPos);
            float influence = smoothstep(12.0, 0.0, dist);
            vec3 finalPos = mix(basePos, uHandPos, influence * 0.8);
            
            // éŸ³é »åæ‡‰ï¼šå‰¯æ­Œæ™‚å¤§å¹…å¢ç›Šçˆ†ç™¼
            float audioAmp = mix(2.0, 8.0, uChorusMode);
            finalPos += normalize(finalPos) * uAudioHigh * hash(i) * audioAmp;

            vec4 mvPosition = modelViewMatrix * vec4(finalPos, 1.0);
            
            // ç²’å­æ„Ÿå°ºå¯¸èª¿æ•´
            float sz = mix(80.0, 180.0, uChorusMode); 
            gl_PointSize = aSize * (sz / -mvPosition.z) * (1.0 + uAudioHigh * 2.5);
            gl_Position = projectionMatrix * mvPosition;
            
            // é¡è‰²éæ¸¡ï¼šå†·è½‰ç†±
            vec3 cNormal = mix(vec3(0.0, 0.4, 1.0), vec3(0.7, 0.1, 1.0), (finalPos.z + 4.0)/8.0);
            vec3 cChorus = mix(vec3(1.0, 0.8, 0.1), vec3(1.0, 0.1, 0.2), hash(i));
            vColor = mix(cNormal, cChorus, uChorusMode);
            vColor += uAudioHigh * mix(0.3, 0.8, uChorusMode);
        }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">
        varying vec3 vColor;
        void main() {
            float dist = length(gl_PointCoord - vec2(0.5));
            float strength = exp(-dist * 12.0); 
            if (dist > 0.5) discard;
            gl_FragColor = vec4(vColor, strength * 0.85);
        }
    </script>

    <script>
        let scene, camera, renderer, particles;
        let audioAnalyser, dataArray;
        const handPos = new THREE.Vector3(200, 200, 200); 
        
        let morphTarget = 0, currentMorph = 0;
        let chorusTarget = 0, currentChorus = 0;
        let lastHandX = 0, gestureCooldown = false;

        async function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 25;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const count = 50000;
            const geometry = new THREE.BufferGeometry();
            const indices = new Float32Array(count);
            const sizes = new Float32Array(count);
            for(let i=0; i<count; i++) { indices[i]=i; sizes[i]=Math.random()*1.0+0.4; }
            geometry.setAttribute('aIndex', new THREE.BufferAttribute(indices, 1));
            geometry.setAttribute('aSize', new THREE.BufferAttribute(sizes, 1));
            geometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(count*3), 3));

            const material = new THREE.ShaderMaterial({
                uniforms: {
                    uTime: { value: 0 }, uAudioHigh: { value: 0 },
                    uChorusMode: { value: 0 }, uHandPos: { value: handPos }, uMorph: { value: 0 }
                },
                vertexShader: document.getElementById('vertexShader').textContent,
                fragmentShader: document.getElementById('fragmentShader').textContent,
                transparent: true, blending: THREE.AdditiveBlending, 
                depthWrite: false, depthTest: false 
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.6 });
            hands.onResults(onHandResults);

            const videoElement = document.createElement('video');
            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 640, height: 480
            });
            cameraUtils.start();

            window.onclick = initAudio;
            animate();
        }

        function onHandResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                const palm = lm[9];
                const currentX = palm.x;
                handPos.x = (currentX - 0.5) * -40;
                handPos.y = (0.5 - palm.y) * 30;

                // æ”¹é€²çš„æ‰‹å‹¢è¾¨è­˜ï¼šæ¯” 1 ä¸¦å¿«é€Ÿå‘å·¦æ®
                const isFingerOne = lm[8].y < lm[6].y && lm[12].y > lm[10].y && lm[16].y > lm[14].y;
                if (isFingerOne && !gestureCooldown && lastHandX - currentX > 0.12) { 
                    morphTarget = 1 - morphTarget;
                    gestureCooldown = true;
                    document.getElementById('current-mode').innerText = morphTarget === 1 ? "èºæ—‹çƒé«”" : "è«æ¯”çƒæ–¯ç’°";
                    setTimeout(() => { gestureCooldown = false; }, 1000);
                }
                lastHandX = currentX;
            } else {
                handPos.lerp(new THREE.Vector3(200,200,200), 0.05);
            }
        }

        async function initAudio() {
            if (audioAnalyser) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioCtx.createMediaStreamSource(stream);
                audioAnalyser = audioCtx.createAnalyser();
                audioAnalyser.fftSize = 512; 
                source.connect(audioAnalyser);
                dataArray = new Uint8Array(audioAnalyser.frequencyBinCount);
                document.getElementById('status').innerText = 'éŸ³è¨Šç›£è½ä¸­...';
            } catch (e) { alert("è«‹å…è¨±éº¥å…‹é¢¨æ¬Šé™"); }
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now() * 0.001;
            particles.material.uniforms.uTime.value = time;
            currentMorph += (morphTarget - currentMorph) * 0.06;
            particles.material.uniforms.uMorph.value = currentMorph;

            if (audioAnalyser) {
                audioAnalyser.getByteFrequencyData(dataArray);
                
                // --- éˆæ•ç‰ˆå‰¯æ­Œåµæ¸¬ ---
                // åªåµæ¸¬ä½é »æ®µ (å‰ 15 å€‹é »è­œé»)ï¼Œé€™éƒ¨åˆ†å—ä½éŸ³é¼“(Bass)å½±éŸ¿æœ€å¤§
                let bassEnergy = 0;
                for(let i=0; i < 15; i++) { bassEnergy += dataArray[i]; }
                const normalizedBass = (bassEnergy / 15) / 255.0;
                
                document.getElementById('energy-level').innerText = (normalizedBass * 100).toFixed(0) + "%";

                // å°‡é–€æª»é™è‡³éå¸¸éˆæ•çš„ 0.20
                if (normalizedBass > 0.20) {
                    chorusTarget = 1.0;
                    document.getElementById('chorus-active').style.display = "block";
                } else {
                    chorusTarget = 0.0;
                    document.getElementById('chorus-active').style.display = "none";
                }

                currentChorus += (chorusTarget - currentChorus) * 0.1;
                particles.material.uniforms.uChorusMode.value = currentChorus;
                // æé«˜é«˜é »é–ƒçˆçš„åæ‡‰é€Ÿåº¦
                particles.material.uniforms.uAudioHigh.value = (dataArray[25] / 255.0) * 1.5;
            }

            particles.rotation.y = time * 0.05;
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
